{% extends "base.html" %}
{% load boss_tags %}
{% load vote %}

{% block extra_css %}
<link href="{{ STATIC_URL }}css/jquery.countdown.css" type="text/css" rel="stylesheet"/>
{% endblock %}

{% block extra_js %}
<script src="{{ STATIC_URL }}js/jquery.countdown.min.js"></script>
<script type="text/javascript">
  window.server_time = new Date(
    {{ server_time.year }},
    {{ server_time.month }},
    {{ server_time.day }},
    {{ server_time.hour }},
    {{ server_time.minute }},
    {{ server_time.second }}
  );

  window.spawn_time = null;
  {% with next_spawn=boss|next_spawn:server %}
    {% if next_spawn != "Unknown" %}
      window.spawn_time = new Date(
        {{ next_spawn.year }},
        {{ next_spawn.month }},
        {{ next_spawn.day }},
        {{ next_spawn.hour }},
        {{ next_spawn.minute }},
        {{ next_spawn.second }}
      );
    {% endif %}
  {% endwith %}

  window.spawn_countdown = null;
  if (window.spawn_time){
    window.spawn_countdown = spawn_time.getTime() - server_time.getTime();
    window.spawn_countdown = window.spawn_countdown / 1000;
    window.spawn_countdown = Math.abs(window.spawn_countdown);
  }

  $(function() {
    if(window.spawn_countdown) {
      $("#boss_countdown").countdown({until: window.spawn_countdown});
    }
  });

  $(function() { $('#id_death_time').datetimepicker(); });

</script>
{% endblock %}

{% block content %}

<div id="detail-titles">
  <h1>{{ server.name }} ||</h1><h2>{{ boss.name }}</h2>
</div>

<h3 class="note">Server Time: {{ server_time }} {{ server.tz }}. Submit when a boss dies in server time.</h3>
  <div id="content-select">
  <p>HEY! Are you a guild on {{ server.name }}?</p>
  <p>If you want your guild's page up here, and you can commit a few people to consistently submit death times, then message prawn.9728! Only accepting one guild to represent per server. Other people can still submit times, but this should keep the river flowing.</p>
  </div>
<div id="next-spawn">
  <div id="spawn-time">
    <h3>next spawn time</h3>
      {% if boss|next_spawn:server != "Unknown" %}
        <!-- Tweet the spawn time, from twitter -->
          <a href="https://twitter.com/share" class="twitter-share-button" data-text="{{ boss.name }} on {{ server.name }} spawns next at {{ boss|next_spawn:server }} ({{ server.tz }}). Keep up at">Tweet</a>
          <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
        <!-- End Twitter -->
      {% endif %}
    <h4>
      {{ boss|next_spawn:server }}

    </h4>
  </div>

  <div id="death_countdown">
    <h3 class="shove">countdown</h3>
    <div id="boss_countdown"></div>
  </div>

  <div id="death_form">
    <h3>submit when boss dies</h3>
    {% if user.is_authenticated %}
    <form method="post">{% csrf_token %}
      {{ death_form.as_p }}
      <input type="submit" value="Submit" />
    </form>

    {% else %}

    <p><a href="{% url registration_register %}">Register here</a> or <a href="{% url auth_login %}">Log In</a> to submit.</p>


    {% endif %}
  </div>
</div>


<table id="death_table">
  <thead align=left>
    <tr>
      <th>votes</th>
      <th>last reported death times</th>
      <th>thanks to</th>
    </tr>
  </thead>
  <tbody>
    {% for death in deaths.by_vote %}
    <tr>
      <td>
	{% if user.is_authenticated %}
	{% vote_form death %}
	{% endif %}
	{{ death.votes.count }}
      </td>
      <td>
	{{ death.died_at }}
      </td>
      <td>
	{{ death.user }}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}
